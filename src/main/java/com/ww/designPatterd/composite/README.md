
# 组合模式

> 将对象组合成树形结构以表示“部分 -整体”的层次结构。组合使得用户对单个对象和组合对象的使用具有一致性


## 如何理解

理解这个设计模式的：**把对象以树形结构放在一起，想要用的时候，操作组合（抽象）对象和操作任意一个对象是一样一样的。** 


### 树形结构

 **组合** 模式的一个关键的定义内容，就是它的表现形式是以树形结构来呈现的，这里还想在墨迹一点东西就是组合模式只是利用了树结构这种形式的结构。

### 一致的访问

``对单个对象和组合对象的使用具有一致性`` 理解成对树形结构当中的根节点、子节点、叶节点的访问方式都是一样的。

**放一张图**

![composite-tree.png](https://i.loli.net/2020/11/18/ix4bmnCvVeZt1WB.png)






## 让我们一起利用它做点事


现在有一个需求，新注册的用户要进行关键信息的填写，性别、年龄。然后在首页根据用户信息进行一些商品的推送。拿到这个需求的时候是不是想着一顿 if else 猛如虎的操作来完成呢？当然我一开始也是这样想的哦，但谁知道产品经理哪天头皮发痒再给我来一个职业、地区、消费能力。。。为了满足产品未来的欲望，我想到了这个。



![composite-code](https://i.loli.net/2020/11/18/PRYgzetrOd1uB9p.png)

通过代码实现以上结构后，



核心代码

```java
 /**
     * 决策
     *
     * @param user 用户信息
     * @return 决策结果
     */
    protected DecisionComponent decision(User user) {
        if (judge(user)) {
            logger.info("进入 {} 决策分支", getName());
            for (DecisionComponent decisionComponent : decisionComponents) {
                if (decisionComponent.judge(user)) {
                    return decisionComponent.decision(user);
                }
            }
        }
        return null;
    }
```



输入参数：男性、35岁

输出结果：

![composite-test-result.png](https://i.loli.net/2020/11/18/ZRQotEphMvnbeL8.png)



## 还有个内容要知道

**透明方式和已知（安全）方式**

关于组合模式除了树形结构、一致的访问，还有一个就是它具体的呈现方式，这个呈现方式指的是对于 **客户端** 也就是高层模块，呈现方式有两种

- 透明的，高层模块不需要去区分是子节点还是叶子节点，一样的去使用，但是对于叶子节点，某些功能可能会失效或出现一些特殊的情况
- 已知（安全）的，需要高层模块自己对子节点或是叶子节点的使用进行选择。

对于透明和已知再通过一个 UML 类图和上面的类图对比加以说明

**透明的组合模式类图**

![composite-UML.png](https://i.loli.net/2020/11/18/IBSMYHvNkALojDb.png)

透明的组合模式希望各个节点（子节点、叶节点）行为与抽象节点一致，这样即高层模块无需关心是否是子节点还是叶节点，方法一样的使用，但是对于子节点，因为其没有继续的分支，所以一些方法是没有具体的实现的，这就导致这些“空方法”高层模块是不知情的，所以称为透明的。



**已知的组合模式类图**

![composite-safe-UML](https://i.loli.net/2020/11/18/Sy2Ed9eG6LOlbZz.png)

这个已知的名字是我起的，书上大多说的是安全方式。要表达的意思就是高层模块需要知道自己调用的节点是子节点还是叶子节点。

## 发现身边的组合模式 📚

相信大家都用过 maven 来管理多模块项目，maven的结构主要分为三类，继承、聚合、依赖，以下这些命令在 root 模块执行的时候，就可以将整个项目完成对应的操作，当你在单个模块中使用的时候，他也只会影响单个模块或该模块以下的模块。

![maven-lifecycle.png](https://i.loli.net/2020/11/18/J67uzqmg8YcAPUd.png)

